<metal:role_table metal:define-macro="role_table">
    <!--! not all roles are defined for all types of base_track_type in all rosters -->
    <tal:if_role_in_base_track_type condition="role in tech_tree.get(base_track_type, [])">

        <h4 id="${base_track_type}-role-${role}">
            <metal:block metal:define-slot="heading" tal:define="unused nothing">
                <!-- nothing if empty -->
            </metal:block>
            <tal:role_heading_anchor condition="not suppress_role_heading_anchor | True">
                <small>
                    <a style="text-decoration:none;"
                        href="#${base_track_type}-role-${role}">
                        &#x1f517;
                    </a>
                </small>
            </tal:role_heading_anchor>
        </h4>

        <metal:block metal:define-slot="description" tal:define="unused nothing">
            <!-- nothing if empty -->
        </metal:block>

        <table style="width:100%; margin-bottom:40px;"
               tal:define="subroles tech_tree[base_track_type][role].keys();
                           intro_years roster.intro_years[base_track_type];"
               tal:condition="len(subroles) > 0">
            <thead>
                <tr>
                    <th style="text-align:right; padding-right: 20px;">Intro Year:</th>
                    <th style="padding-right: 20px;" tal:repeat="intro_year intro_years">${intro_year}</th>
                    <td><!--! empty space cell --></td>
                </tr>
            </thead>
            <tbody>
                <tal:roles repeat="subrole subroles">
                    <tal:subrole_child_branch tal:repeat="subrole_child_branch doc_helper.get_subrole_child_branches_in_order(tech_tree[base_track_type][role][subrole].keys())">
                        <tr style="border-top: solid ${'2px #ccc' if subrole in ['branch_freight', 'heavy_freight', 'super_heavy_freight', 'heavy_express', 'super_heavy_express', 'pax_railcar', 'hst', 'lolz'] else '1px #eee'};
                                   box-shadow: inset 0 -1px #fff;
                                   background: linear-gradient(180deg, #fff 0%, #fafafa 100%);">
                            <th style="text-align: right; width: 180px; padding-right: 20px;"
                                class="has-child-branch-tooltip"
                                id="${base_track_type}-${role}-${subrole}-${subrole_child_branch}">
                                <div class="child-branch-tooltip">
                                    <ul>
                                        <li>Role: ${role}</li>
                                        <li>Subrole: ${subrole}</li>
                                        <li>Branch number: ${subrole_child_branch}</li>
                                        <li tal:condition="subrole_child_branch < 0">Joker</li>
                                    </ul>
                                </div>
                                <!--! this string mangling will be fragile if roles change eh -->
                                <span tal:condition="'branch' in subrole">
                                    Light
                                </span>
                                <span tal:condition="'super' in subrole">
                                    Super
                                </span>
                                <span tal:condition="'ultra' in subrole">
                                    Ultra
                                </span>
                                <!--! order of 'heavy' is significant -->
                                <span tal:condition="'heavy' in subrole">
                                    Heavy
                                </span>
                                <span tal:condition="'pax' in subrole">
                                    Passenger
                                </span>
                                <span tal:condition="'mail' in subrole">
                                    Mail
                                </span>
                                <span tal:condition="'railbus' in subrole">
                                    Railbus
                                </span>
                                <span tal:condition="'railcar' in subrole">
                                    Railcar
                                </span>
                                <span tal:condition="'express_railcar' in role">
                                    Express
                                </span>
                                <span tal:condition="'mail_railcar' not in subrole and 'pax_railcar' and 'pax_railbus' and 'express_railcar' not in role and 'hst' not in role">
                                    ${doc_helper.get_role_string_from_subrole(subrole, iron_horse.badge_manager)}
                                </span>
                                <a style="text-decoration:none;"
                                    href="#${base_track_type}-${role}-${subrole}-${subrole_child_branch}">
                                    &#x1f517;
                                </a>
                            </th>
                            <td tal:repeat="gen range(1, len(intro_years) + 1)" class="text-center" style="width: 160px;">
                                <tal:example_model_variant define="catalogue tech_tree[base_track_type][role][subrole][subrole_child_branch][gen];">
                                    <tal:block condition="catalogue is not None"
                                               define="example_model_variant catalogue.example_model_variant if catalogue is not None else None;">
                                        <div id="${example_model_variant.model_id}"
                                             class="tech_tree_vehicle_container">
                                            <a href="${example_model_variant.model_id}.html">
                                                <div class="tech_tree_vehicle
                                                            ${'tech_tree_vehicle_electric_' + example_model_variant.electrification_type.lower() if example_model_variant.requires_electric_rails else 'None'}
                                                            ${'tech_tree_vehicle_electro_diesel' if example_model_variant.is_electro_diesel else None}
                                                            ${'tech_tree_vehicle_arrow' if catalogue.next_gen_catalogue is not None else None}">
                                                    <span style="display:block;">
                                                        ${example_model_variant.name}
                                                    </span>
                                                    <img src="static/img/${example_model_variant.id}_${vehicle_cc}.png"
                                                         width="${2 * doc_helper.docs_sprite_width(catalogue=catalogue)}"
                                                         height="${2 * doc_helper.docs_sprite_height}" />
                                                    <span style="display:block; margin-top: 5px; line-height:1.3;" class="muted">
                                                        <small>
                                                            <tal:power repeat="power_string doc_helper.power_formatted_for_docs(catalogue)">
                                                                <span style="display:block">${power_string}</span>
                                                            </tal:power>
                                                        </small>
                                                        <!--!
                                                            this is a lolz JFDI hack to provide equal height spacing when there are 1 or 2 power sources
                                                            this will fail with more than 2 power sources, but deal with that later by adding more conditions
                                                        -->
                                                        <tal:linebreak condition="(len(doc_helper.power_formatted_for_docs(catalogue)) == 1) and (example_model_variant.lgv_capable == False)">
                                                            <br />
                                                        </tal:linebreak>
                                                        <small>${doc_helper.speed_formatted_for_docs(catalogue)}</small>

                                                        <small>${example_model_variant.power_speed_ratio}i</small>
                                                        <tal:branch condition="example_model_variant.roster.id != 'pony'">
                                                            <small>branch: ${example_model_variant.subrole_child_branch_num}</small>
                                                        </tal:branch>
                                                    </span>
                                                </div>
                                                <div tal:condition="catalogue.next_gen_catalogue is not None"
                                                     style="float:left; margin-left: 173px; margin-top: 30px;">
                                                     <div style="${'visibility:hidden;' if doc_helper.model_has_direct_replacement_in_tree(example_model_variant) else nothing}">
                                                        <a href="${catalogue.next_gen_catalogue.model_id}.html">
                                                            <div class="muted"
                                                                 style="width: 100px; border: solid 1px #ddd; background: #fffff3; border-radius: 4px; padding: 8px;">
                                                                Replaced by ${doc_helper.unpack_name_string(catalogue.next_gen_catalogue)}
                                                            </div>
                                                        </a>
                                                    </div>
                                                </div>
                                            </a>
                                        </div>
                                    </tal:block>
                                </tal:example_model_variant>
                            </td>
                            <td><!--! empty space cell --></td>
                        </tr>
                    </tal:subrole_child_branch>
                </tal:roles>
            </tbody>
        </table>
    </tal:if_role_in_base_track_type>
</metal:role_table>
