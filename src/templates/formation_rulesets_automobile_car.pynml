<!--! position rulesets for formation-position-dependent vehicles -->

// automobile transporter articulated permanent twin set
<tal:ruleset define="first 0; last 1;">
    <!--! first / last; NOTE use of position_in_articulated_veh not position_in_vehid_chain -->
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_articulated_permanent_twin_sets, position_in_articulated_veh % 2) {
        0: return ${first};
        return ${last};
    }
</tal:ruleset>

// automobile transporter 1 unit sets
<tal:ruleset define="default 0;">
    <!--!
        if 1 unit in sequence
        - note that this just yields a constant result and will likely be optimised out by nmlc but eh, consistency with other switches for now
    -->
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_1_unit_sets, 0) {
        0: return ${default};
    }
</tal:ruleset>

// automobile transporter max 2 unit sets
<tal:ruleset define="default 0; first 1; last 2;">
    <!--! more than two in chain, inner location -->
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_2_unit_sets_not_single_not_first_or_last, [
                switch_pseudo_random_freight_ruleset_map_max_2_unit_sets()
            ]) {
        0: return ${default};
        1: return ${first};
        2: return ${last};
    }
    <!--! last, more than one in chain -->
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_2_unit_sets_not_single_is_last, [
                switch_pseudo_random_freight_ruleset_map_max_2_unit_sets()
            ]) {
        0: ${default};
        1: ${default};
        2: ${last};
    }
    <!--! first, more than one in chain -->
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_2_unit_sets_not_single_is_first, [
                switch_pseudo_random_freight_ruleset_map_max_2_unit_sets()
            ]) {
        0: ${default};
        1: ${first};
        2: ${default};
        3: ${first};
    }
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_2_unit_sets, [
                <!--! this is a daft ternary, but will only evaluate to 0, 1, 2, or 3
                    (a single unit chain will be 3 as it is both first and last)
                    the results of this ternary are *NOT* related to the position results from the ruleset procedure
                    -->
                ((LOAD_TEMP(k_addr_position_in_badge_predicate_chain) == 0) ? 1 : 0)
                +
                ((LOAD_TEMP(k_addr_position_in_badge_predicate_chain_from_end) == 0) ? 2 : 0)
            ]) {
        0: switch_graphics_automobile_transporter_ruleset_max_2_unit_sets_not_single_not_first_or_last;
        1: switch_graphics_automobile_transporter_ruleset_max_2_unit_sets_not_single_is_first;
        2: switch_graphics_automobile_transporter_ruleset_max_2_unit_sets_not_single_is_last;
        3: ${default}; <!--! single unit -->
    }
</tal:ruleset>


// automobile transporter max 4 unit sets
<tal:ruleset define="default 0; first 1; last 2; middle 3;">
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_4_unit_sets_not_single_not_first_or_last, [
                switch_pseudo_random_freight_ruleset_map_max_4_unit_sets()
            ]) {
        0: return ${default};
        1: return ${first};
        2: return ${last};
        3: return ${middle};
    }
    <!--! last, more than one in chain -->
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_4_unit_sets_not_single_is_last, [
                switch_pseudo_random_freight_ruleset_map_max_4_unit_sets()
            ]) {
        0: ${default};
        1: ${default};
        2: ${last};
        3: ${last};
    }
    <!--! first, more than one in chain -->
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_4_unit_sets_not_single_is_first, [
                switch_pseudo_random_freight_ruleset_map_max_4_unit_sets()
            ]) {
        0: ${default};
        1: ${first};
        2: ${default};
        3: ${first};
    }
    switch (FEAT_TRAINS, SELF, switch_graphics_automobile_transporter_ruleset_max_4_unit_sets, [
                <!--! this is a daft ternary, but will only evaluate to 0, 1, 2, or 3
                    (a single unit chain will be 3 as it is both first and last)
                    the results of this ternary are *NOT* related to the position results from the ruleset procedure
                    -->
                ((LOAD_TEMP(k_addr_position_in_badge_predicate_chain) == 0) ? 1 : 0)
                +
                ((LOAD_TEMP(k_addr_position_in_badge_predicate_chain_from_end) == 0) ? 2 : 0)
            ]) {
        0: switch_graphics_automobile_transporter_ruleset_max_4_unit_sets_not_single_not_first_or_last;
        1: switch_graphics_automobile_transporter_ruleset_max_4_unit_sets_not_single_is_first;
        2: switch_graphics_automobile_transporter_ruleset_max_4_unit_sets_not_single_is_last;
        3: ${default}; <!--! single unit -->
    }
</tal:ruleset>
